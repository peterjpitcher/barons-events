# EventHub Website Publishing API (v1)

This document explains how the brand website should pull event data from EventHub.

## Values to fill in (copy/paste)
- **Base URL**: `https://eventhub.orangejelly.co.uk`
- **API key**: `<PASTE_EVENTHUB_WEBSITE_API_KEY_HERE>`
  - Used as: `Authorization: Bearer <PASTE_EVENTHUB_WEBSITE_API_KEY_HERE>`

## Overview
- **Intended usage**: server-to-server (do not call from the browser).
- **Visibility rule**: only events with status `approved` or `completed` are returned.
- **Data safety**: this API intentionally excludes internal planning/review/debrief/cost fields.
- **Ordering**: event lists are ordered by `startAt` ascending, then `id` ascending.

## Authentication
All endpoints require a bearer token.

- EventHub environment variable: `EVENTHUB_WEBSITE_API_KEY`
- Request header:
  - `Authorization: Bearer <EVENTHUB_WEBSITE_API_KEY>`

Keep the API key server-side only. Do not expose it to client-side JavaScript.

## Base URL
Use your EventHub deployment URL:
- Local dev: `http://localhost:3000`
- Production: `https://eventhub.orangejelly.co.uk`

## Quickstart (curl)
```bash
curl -H "Authorization: Bearer <EVENTHUB_WEBSITE_API_KEY>" \
  "https://eventhub.orangejelly.co.uk/api/v1/events?from=2026-01-20T15:00:00.000Z&limit=50"
```

## Endpoints

### Health
`GET /api/v1/health`

Use this to verify connectivity + auth.

Response (200):
```json
{ "ok": true }
```

### OpenAPI
`GET /api/v1/openapi`

Returns an OpenAPI 3.1 JSON spec (importable into Postman / Insomnia / Swagger tooling).

### Venues
`GET /api/v1/venues`

Response (200):
```json
{
  "data": [
    {
      "id": "uuid",
      "name": "Barons Riverside",
      "address": "12 River Walk, Guildford",
      "capacity": 180
    }
  ]
}
```

### Event types
`GET /api/v1/event-types`

Response (200):
```json
{
  "data": [
    { "id": "uuid", "label": "Tap Takeover", "created_at": "2025-01-02T12:34:56.000Z" }
  ]
}
```

### List public events
`GET /api/v1/events`

#### Query parameters
- `limit` (default `50`, max `200`) — page size
- `cursor` — opaque cursor from a previous response
- `from` — ISO date-time; filters `startAt >= from`
- `to` — ISO date-time; filters `startAt <= to`
- `endsAfter` — ISO date-time; filters `endAt >= endsAfter` (useful for “upcoming + currently running”)
- `updatedSince` — ISO date-time; filters `updatedAt > updatedSince`
- `venueId` — venue UUID filter
- `eventType` — event type exact match

#### Response (200)
```json
{
  "data": [/* PublicEvent[] */],
  "meta": { "nextCursor": "string-or-null" }
}
```

#### Upcoming events (website usage)
To show upcoming events only, call:
- `/api/v1/events?from=<NOW_UTC_ISO>`

Example:
`/api/v1/events?from=2026-01-20T15:00:00.000Z&limit=200`

If you want “upcoming + currently running”, use:
- `/api/v1/events?endsAfter=<NOW_UTC_ISO>`

### Fetch a public event by id
`GET /api/v1/events/:eventId`

Response (200):
```json
{ "data": {/* PublicEvent */} }
```

### Fetch a public event by slug
`GET /api/v1/events/by-slug/:slug`

Slugs are generated by EventHub as:
`<slugified-seo-slug-or-title>--<eventId>`

This endpoint extracts the `eventId` from the slug and returns the event payload.

Response (200):
```json
{
  "data": {/* PublicEvent */},
  "meta": {
    "requestedSlug": "the-slug-you-sent",
    "canonicalSlug": "the-current-canonical-slug",
    "isCanonical": true
  }
}
```

Canonical behavior is up to the website implementation. The `meta` block is provided so you can choose to 301 redirect, rewrite, or ignore.

## PublicEvent payload
Each public event returned by the API has this shape:

```ts
type PublicEvent = {
  id: string; // uuid
  slug: string; // "<slugBase>--<eventId>" (slugBase is `seoSlug` if present, else `title`)
  title: string; // guest-facing title (prefers `events.public_title`, falls back to `events.title`)
  teaser: string | null; // short hook for cards/tiles
  highlights: string[]; // short USP lines for quick scanning
  eventType: string;
  status: "approved" | "completed";
  startAt: string; // ISO date-time (UTC)
  endAt: string; // ISO date-time (UTC)
  venueSpaces: string[]; // parsed from the internal comma-separated venue_space field
  description: string | null; // guest-facing description (prefers `events.public_description`, falls back to `events.notes`); treat as plain text
  bookingType: "ticketed" | "table_booking" | "free_entry" | "mixed" | null;
  ticketPrice: number | null;
  checkInCutoffMinutes: number | null;
  agePolicy: string | null;
  accessibilityNotes: string | null;
  cancellationWindowHours: number | null;
  termsAndConditions: string | null;
  bookingUrl: string | null; // optional booking link (full URL)
  eventImageUrl: string | null; // public storage URL if an event image exists
  seoTitle: string | null; // optional SEO title (<= 60 chars); in EventHub UI we include the event date to disambiguate repeats
  seoDescription: string | null; // optional SEO description (<= 155 chars); in EventHub UI we include the event date to disambiguate repeats
  seoSlug: string | null; // optional base slug; in EventHub UI we include the date (recommended pattern: <base>-YYYY-MM-DD)
  wetPromo: string | null;
  foodPromo: string | null;
  venue: {
    id: string; // uuid
    name: string;
    address: string | null;
    capacity: number | null;
  };
  updatedAt: string; // ISO date-time (UTC)
};
```

### Example payload
```json
{
  "id": "aaaaaaa1-0000-4000-8000-000000000001",
  "slug": "quiz-night-2026-01-06--aaaaaaa1-0000-4000-8000-000000000001",
  "title": "Quiz Night with Elliott",
  "teaser": "Get your team together and book in early.",
  "highlights": ["Hosted by Elliott", "Prizes for top teams", "Book early to secure a table"],
  "eventType": "Quiz Night",
  "status": "approved",
  "startAt": "2026-01-06T19:30:00.000Z",
  "endAt": "2026-01-06T21:30:00.000Z",
  "venueSpaces": ["Main Bar"],
  "description": "Guest-facing description text…",
  "bookingType": "table_booking",
  "ticketPrice": null,
  "checkInCutoffMinutes": 30,
  "agePolicy": "18+ only (ID required)",
  "accessibilityNotes": "Step-free access available. Contact venue for support.",
  "cancellationWindowHours": 24,
  "termsAndConditions": "Please arrive on time. Late entry may be refused.",
  "bookingUrl": "https://example.com/book",
  "eventImageUrl": "https://<supabase>/storage/v1/object/public/event-images/<event-id>/hero.jpg",
  "seoTitle": "Quiz Night with Elliott | 6 Jan 2026",
  "seoDescription": "Join us for Quiz Night with Elliott on 6 Jan 2026 at The Cricketers. Book now.",
  "seoSlug": "quiz-night-with-elliott-2026-01-06",
  "wetPromo": null,
  "foodPromo": null,
  "venue": {
    "id": "9f9c5da2-8a6e-4db0-84b7-8ae0b25177e7",
    "name": "The Cricketers",
    "address": "12 River Walk, Guildford",
    "capacity": 180
  },
  "updatedAt": "2025-04-01T12:00:00.000Z"
}
```

### Formatting notes
- `startAt` / `endAt` are UTC; the website should format into local time for display.
- `description` is plain text (may include line breaks); the website can render as paragraphs if desired.

### Field sourcing (EventHub database)
EventHub stores events in `public.events`. The API maps fields like this:
- `PublicEvent.id` → `events.id`
- `PublicEvent.title` → `events.public_title` (fallback `events.title`)
- `PublicEvent.teaser` → `events.public_teaser`
- `PublicEvent.description` → `events.public_description` (fallback `events.notes`)
- `PublicEvent.bookingUrl` → `events.booking_url`
- `PublicEvent.seoTitle` → `events.seo_title`
- `PublicEvent.seoDescription` → `events.seo_description`
- `PublicEvent.seoSlug` → `events.seo_slug`
- `PublicEvent.slug` → computed by EventHub as `<slugBase>--<eventId>` where `slugBase` is `seoSlug` if present, else `title`

## Pagination
`GET /api/v1/events` returns `meta.nextCursor`.

- If `nextCursor` is `null`, you’re done.
- If it’s a string, pass it into the next call as `?cursor=<nextCursor>`.

Example (pseudo-code):
```ts
let cursor: string | null = null;
do {
  const url = new URL(`${baseUrl}/api/v1/events`);
  url.searchParams.set("limit", "200");
  if (cursor) url.searchParams.set("cursor", cursor);

  const res = await fetch(url, { headers: { Authorization: `Bearer ${apiKey}` } });
  const body = await res.json();

  upsert(body.data);
  cursor = body.meta.nextCursor;
} while (cursor);
```

## Incremental sync strategy (recommended)
For a website that maintains its own cache/CMS table, use `updatedSince`:

1) Store a `lastSyncUpdatedAt` timestamp.
2) Call `/api/v1/events?updatedSince=<lastSyncUpdatedAt>&limit=200` and paginate.
3) Upsert all returned events into your store.
4) Set `lastSyncUpdatedAt = max(updatedAt)` from the events you processed.

Note: `updatedSince` does not explicitly report events that became non-public later. If you need removal detection, run a periodic full resync (e.g. nightly) and delete anything not returned.

## Caching
EventHub sends `cache-control` headers (short-lived) on API responses. The website can additionally cache responses server-side if desired, but should respect `updatedAt` for freshness and use `updatedSince` for incremental updates.

## Slug + canonical strategy (recommended)
The `slug` field is designed for stable website URLs even when titles change:
- Always link internally by `id`.
- Use `/api/v1/events/by-slug/:slug` for route-based fetching.
- If `meta.isCanonical` is `false`, you can choose to:
  - 301 redirect to `meta.canonicalSlug` (good for SEO), or
  - rewrite internally but keep the requested URL.

## Error responses
Errors are JSON in this shape:
```json
{
  "error": {
    "code": "string",
    "message": "string",
    "details": {}
  }
}
```

Common statuses:
- `401` `unauthorized` — missing/invalid API key
- `400` `invalid_request` / `invalid_cursor` / `invalid_slug`
- `503` `not_configured` — EventHub missing server config (API key env var or Supabase service-role key)
- `500` `internal_error`

## Quick Postman setup
1) Create a new request.
2) Method: `GET`
3) URL: `<baseUrl>/api/v1/health`
4) Authorization tab:
   - Type: `Bearer Token`
   - Token: your `EVENTHUB_WEBSITE_API_KEY`
5) Send → expect `200` with `{"ok": true}`.

Next:
- `GET <baseUrl>/api/v1/events?from=<NOW_UTC_ISO>&limit=25`
- `GET <baseUrl>/api/v1/openapi` (to import into API tooling)

## Curl examples
```bash
curl -H "Authorization: Bearer $EVENTHUB_WEBSITE_API_KEY" \
  "https://<your-eventhub-domain>/api/v1/events?limit=50"
```

```bash
curl -H "Authorization: Bearer $EVENTHUB_WEBSITE_API_KEY" \
  "https://<your-eventhub-domain>/api/v1/events/by-slug/cask-ale-showcase--aaaaaaa1-0000-4000-8000-000000000001"
```
